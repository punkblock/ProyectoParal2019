#include <iostream>
#include <xlnt/xlnt.hpp>
#include <string.h>

using namespace std;

//Funcion para contar filas de los archivos.xlsx
int contarFilas(char *argumento){
    xlnt::workbook wb;
    wb.load(argumento);
    int contador = 0;
    auto ws = wb.active_sheet();
    for (auto row : ws.rows(false)) 
    { 
	contador = contador + 1;
    }
    return contador;
}

void crear_hojas(){
    // LLENADO DE MATRICES
    //Creamos un vector con 2 dimensiones
    vector<vector<string>> wholeWorksheet;

    //Creamos 7 filas
    for (int outer = 0; outer < 7; outer++)
    {
    	std::vector<std::string> singleRow;
    //Creamos 7 columnas
    	for(int inner = 0; inner < 7; inner++)
    	{
		//Agregamos un valor a cada columna y fila
		string val = to_string(inner + 1);
		singleRow.push_back(val);            
    	}

    // Agregando la fila única al vector bidimensional
    wholeWorksheet.push_back(singleRow);
    cout << "Writing to row " << outer << " in the vector " <<endl;
    }

// FIN DE LLENADO DE MATRIZ DE PRUEBA //

//COMIENZA AGREGADO DE N HOJAS (MAX 18 HOJAS) 

    cout << "Creación de libro de trabajo" <<endl;

    // Configuración del nombre del archivo de salida de destino
    string dest_filename = "Horario.xlsx";
    string dest_filename_1 = "Horario_1.xlsx";
    string dest_filename_2 = "Horario_2.xlsx";

    // Creamos el libro 
    xlnt::workbook wbOut;
    xlnt::workbook wbOut_1;
    xlnt::workbook wbOut_2;

    //xlnt::worksheet ws1 = wbOut.sheet_by_title("Hoja 1");

    // LIBRO 1 
    int i =0;
    for (i; i<=14 ; i++){
        // Agregar hoja de cálculo.
	xlnt::worksheet i = wbOut.create_sheet(); 
    }
    xlnt::worksheet ws1 = wbOut.create_sheet(); 
    xlnt::worksheet ws2 = wbOut.create_sheet(); 
    ws2.title("HOJA18");

   // LIBRO 2
   /*
   int i2 =0;
    for (i2; i2<=14 ; i2++){
        // Agregar hoja de cálculo.
	xlnt::worksheet i2 = wbOut.create_sheet(); 
    }
    xlnt::worksheet ws3 = wbOut_1.create_sheet(); 
    xlnt::worksheet ws4 = wbOut_1.create_sheet(); 
    ws4.title("HOJA18");
   */
   

    
 
    
    // Ahora haremos un bucle a través del vector bidimensional que creamos arriba
    // En este caso tenemos dos iteradores, uno para el bucle externo (fila) y otro para el bucle interno (columna)
    cout << "Looping through vector and writing to spread sheet" <<endl;

    for (int fOut = 0; fOut < wholeWorksheet.size(); fOut++)
    {
        cout << "Row" << fOut <<endl;

        for (int fIn = 0; fIn < wholeWorksheet.at(fOut).size(); fIn++)
        {
	// Tome nota de la diferencia entre acceder al vector y acceder a la hoja de trabajo
	// Como ya sabrá, las hojas de cálculo de Excel comienzan en la fila 1 y en la columna 1 (no en la fila 0 y en la columna 0 		como cabría esperar de un vector C ++)
	// En resumen, la referencia de la celda xlnt comienza en la columna 1, fila 1 (por lo tanto, los + 1 más abajo) y la 		referencia del vector comienza en la fila 0 y la columna 0
	

        ws2.cell(xlnt::cell_reference(fIn + 1, fOut + 1)).value(wholeWorksheet.at(fOut).at(fIn));
        // Más aclaraciones para evitar confusiones.
        // Los argumentos de referencia de celda son (número de columna, número de fila); p.ej. cell_reference (fIn + 1, fOut + 1)
        // Los argumentos de vectores son (número de fila, número de columna); p.ej. wholeWorksheet.at (fOut) .at (fIn)
    	}
    }
    //wst.title("Hoja2");
    std::clog << "Hoja de cálculo de escritura terminada" << std::endl;

    // GUARDO LIBRO
    wbOut.save(dest_filename); 
    //wbOut_1.save(dest_filename_1);
}

// Funcion materias repetidas
void MateriasProfesor(char *argumento)
{
    xlnt::workbook wb;
    wb.load(argumento);
    int contador = 0;
    auto ws = wb.active_sheet();

	/* toda la hoja de cálculo */
	std::vector< std::vector<std::string> > hoja_calculo;
	std::vector< std::vector<std::string> > columna_c;
	for (auto row : ws.rows(false)){ 

		// Creando un vector nuevo solo para esta fila en la hoja de cálculo
		vector<string> fila_simple;

		for (auto cell : row){ 
		    //Añadiendo esta celda a la fila;
		    fila_simple.push_back(cell.to_string());
		}

		//Agregando esta fila completa al vector que almacena toda la hoja de cálculo;
		hoja_calculo.push_back(fila_simple);
        }

    // Cantidad de materias que tiene un profesor
	int contador_bloques = 0;
    // Variable para ver si existe más de una vez el profesor
    int existe = 0;
    // Nombre del profesor
    string nombre;
    // id del profesor
    int idNumero = 0;
    // Arreglo con los id de cada profesor
    int idNumeros[500];
    // Variable auxiliar donde se guarda idNumero como string
    string nombreNumero;
    // Primer For para recorrer el archivo completo
    for (int fila = 1; fila < hoja_calculo.size(); fila++){
        contador_bloques = 0;
        existe = 0;
        // Se guarda nombre del profesor
        nombre = hoja_calculo.at(fila).at(3);
        // Se guarda idNumero como string
        nombreNumero = hoja_calculo.at(fila).at(2);
        // Se convierte idNumero a entero
        idNumero = stoi(nombreNumero, nullptr);
        // Se agrega el idNumero al arreglo de los id
        idNumeros[fila] = idNumero;
        // Se recorre idNumeros[] para saber si ya se conto la cantidad de materias
        // Que tiene asignadas el profesor
        for (int i = 0 ; i < 500; i++)
        {
            // Si existe el id en el arreglo, entonces existe++
            if (idNumero == idNumeros[i+1])
            {
                //cout << "EXISTE ID: " << idNumeros[i] << endl;
                existe++;
            }
        }
        // Si no existe el id en el arreglo se cuenta cuantas veces se repite el id del profesor
        // Para saber cuantas materias tiene asignadas
        if (existe < 2)
                {
		    //cout << "No existe ID: " << endl;
            // Se recorre Cursos.xlsx 
	        for (int fila2 = 0; fila2 < hoja_calculo.size(); fila2++)
	        {
		      for (int columna2 = 0; columna2 < hoja_calculo.at(fila2).size(); columna2++)
		      {

		      }
                // Se compara el nombre del profesor en el archivo
	            if(nombre==(hoja_calculo.at(fila2).at(3)))
                {
                    // Se guarda la cantidad de veces que existe el nombre del profesor
		            contador_bloques++;
		        
	            }
	        }
            // Muestra el numero de fila que aparece el profesor por primera vez
	        cout << "NUMERO DE FILA" << fila << endl;
            // Muestra el nombre del profesor y la cantidad de ramos
            cout<<"Profesor: "<<nombre<<" , cantidad de ramos: "<<contador_bloques<<endl;
        }
    }

}


int main( int argc, char *argv[])
{
    //argc: numero total de argumentos pasados por linea de comandos
    //argv: array con los argumentos pasados por linea de comandos

    //Variable para guardar el argumento
    string argumento;

    crear_hojas();
    //Leyendo los argumentos por argumentos
    for (int i = 0; i < argc; i++)
    {
	argumento = argv[i];
	//Si argumento es igual a -s, se utiliza Salas.xlsx
	if (argumento == "-s")
        {
            cout << "Numero de filas en " << argv[i + 1] << ": " << contarFilas(argv[i + 1]) << endl;
        }
	//Si argumento es igual a -d, se utiliza Docentes.xlsx
        else if (argumento == "-d")
        {
            cout << "Numero de filas en " << argv[i + 1] << ": " << contarFilas(argv[i + 1]) << endl;
        }
	//Si argumento es igual a -c, se utiliza Cursos.xlsx
	else if(argumento == "-c")
        {
            cout << "Numero de filas en " << argv[i + 1] << ": " << contarFilas(argv[i + 1]) << endl;
            cout << "Funcion de materias repetidas " << endl;
            MateriasProfesor(argv[i +1]);
        }
    }
    
    return 0;
}
